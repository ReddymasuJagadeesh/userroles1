@model UserRoles.ViewModels.CreateUserViewModel
@using UserRoles.Models

@{
    bool isAdmin = User.IsInRole("Admin");
    var managers = ViewBag.Managers as IList<Users>;
    var selectedManagerId = Context.Request.Query["managerId"].ToString();
}

<h3>Add User</h3>

<form asp-action="Create" method="post" novalidate>
    @Html.AntiForgeryToken()

    <!-- NAME -->
    <div class="mb-3">
        <label class="form-label">Name</label>
        <input asp-for="Name"
               id="nameInput"
               class="form-control"
               maxlength="20"
               autocomplete="off"
               required />
        <small id="nameError" class="text-danger d-none">
            Name must contain only letters (max 20 characters)
        </small>
    </div>

    <!-- EMAIL -->
    <div class="mb-3">
        <label class="form-label">Email</label>
        <input asp-for="Email"
               id="emailInput"
               type="text"
               class="form-control"
               autocomplete="off"
               required />

        <small id="emailError" class="text-danger d-none">
            Enter a valid email address
        </small>
    </div>

    <!-- ROLE -->
    @if (isAdmin)
    {
        <div class="mb-3">
            <label class="form-label">Role</label>
            <select name="role" class="form-select">
                <option value="Manager">Manager</option>
                <option value="User" selected="@(!string.IsNullOrEmpty(selectedManagerId))">
                    User
                </option>
            </select>

        </div>
    }
    else
    {
        <input type="hidden" asp-for="Role" value="User"  />
    }

    <!-- 🔥
    <div class="mb-3 d-none" id="managerDiv">
            <label>Manager</label>
            <select asp-for="ManagerId" class="form-select">
             
            </select>
            <span asp-validation-for="ManagerId" class="text-danger"></span>
        </div>
    MANAGER DROPDOWN -->
    

    @if (User.IsInRole("Admin"))
    {
        


        <div class="mb-3">
            <label class="form-label fw-semibold">Reports To</label>

            <select name="managerId" class="form-select">
                <option value="ADMIN">Admin</option>

                @foreach (var mgr in ViewBag.Managers)
                {
                    <option value="@mgr.Id">@mgr.Name</option>
                }
            </select>

            <small class="text-muted">
                Select Admin or another Manager
            </small>
        </div>

    }


    @if (!string.IsNullOrEmpty(selectedManagerId))
    {
        <input type="hidden" name="managerId" value="@selectedManagerId" />
    }




    <!-- INFO -->
    <div class="alert alert-info py-2">
        🔐 Password will be generated and sent to user email.
    </div>

    <!-- BUTTONS -->
    <button type="submit" class="btn btn-success">Create User</button>
    <a asp-action="Index" class="btn btn-secondary ms-2">Cancel</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const roleSelect = document.getElementById("roleSelect");
        const managerDiv = document.getElementById("managerDiv");

        function toggleManager() {
            if (roleSelect.value === "User") {
                managerDiv.classList.remove("d-none");
            } else {
                managerDiv.classList.add("d-none");
            }
        }

        toggleManager();
        roleSelect.addEventListener("change", toggleManager);
    </script>
   
    <script>
            document.getElementById('addUserForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        if (addBtn.disabled) return; // safety

        const formData = new FormData(this);

        // prevent numbers & special chars in name
        nameInput.addEventListener('keypress', function (e) {
            const char = String.fromCharCode(e.which);
            if (!/[a-zA-Z\s]/.test(char)) {
                e.preventDefault();
            }
        });
    </script>

    <script>
        // NAME VALIDATION
        const nameInput = document.getElementById("nameInput");
        const nameError = document.getElementById("nameError");

        nameInput.addEventListener("input", function () {
            const value = nameInput.value;
            const valid = /^[A-Za-z\s]*$/.test(value) && value.length <= 20;

            if (!valid) {
                nameError.classList.remove("d-none");
                nameInput.classList.add("is-invalid");
            } else {
                nameError.classList.add("d-none");
                nameInput.classList.remove("is-invalid");
            }
        });

        // EMAIL VALIDATION
        const emailInput = document.getElementById("emailInput");
    const emailError = document.getElementById("emailError");

    emailInput.addEventListener("input", function () {
        const email = emailInput.value.trim();

        const emailRegex =
            /^[A-Za-z0-9._%+-]+@@[A-Za-z0-9-]+\.[A-Za-z]{2,}$/;

        if (email === "") {
            emailError.classList.add("d-none");
            emailInput.classList.remove("is-invalid");
            return;
        }

        if (!emailRegex.test(email)) {
            emailError.classList.remove("d-none");
            emailInput.classList.add("is-invalid");
        } else {
            emailError.classList.add("d-none");
            emailInput.classList.remove("is-invalid");
        }

        });
    </script>
}
